---
title: Аналитика временных рядов
url: https://education.yandex.ru/handbook/ml/article/analitika-vremennyh-ryadov
course: ml
chapter: 10. Практические главы
chapter_id: 10.3
---
Временной ряд – зависимые между собой наблюдения. Например, температура воздуха сегодня достаточно сильно зависит от вчерашнего показателя температуры. Эту зависимость хотелось бы описать численно. Для этого часто используют разные виды коэффициентов корреляции, например, корреляции Пирсона, Спирмена и Кендалла. Каждый из этих коэффициентов корреляции вычисляется по двум выборкам, корреляцию между которыми требуется посчитать. В данном случае мы имеем один временной ряд, и наша задача – оценить корреляцию между разными наблюдениями ряда, считая, что она не меняется со временем.
В качестве оценки корреляции значений
t+τ
для любых
t
t рассмотрим коэффициент корреляции Пирсона ряда с самим собой со сдвигом на
τ
τ. Тем самым мы получим численную оценку степени влияния значения
y
t
y
t
на значение
y
t
+
τ
y
t+τ
corr
(y
t
,y
t+τ
)=
t=1
t=1
∑
T−τ
(y
t
−
y
)(y
t+τ
−
y
)
,
где
τ
τ – лаг автокорреляции, а среднее вычисляется по всему ряду
t=1
∑
T
y
t
. Например, если мы хотим оценить степень влияния сегодняшней температуры на завтрашнюю, то посчитаем коэффициент корреляции исходного ряда и им же, сдвинутым на 1 день.
Замечание. Формула содержит некоторые упрощения при оценке ковариации и дисперсий.
Свойства коэффициента корреляции:
∣⩽1;
=0 – отсутствие автокорреляции, при этом значения могут быть зависимыми (см. подробнее про разницу между независимостью и некоррелированностью);
>0 – положительная корреляция, то есть чем больше было значение вчера, тем оно будет больше сегодня;
<0 – отрицательная корреляция, то есть чем больше было значение вчера, тем оно будет меньше сегодня;
∣=1 означает строгую линейную зависимость.
Посмотреть простые примеры и потренировать свою интуицию вы можете в игре Guess The Correlation.
Пусть мы посчитали значение автокорреляции. А как понять, значение 0.1 – это много или мало? На этот вопрос может ответить статистический критерий Льюнга-Бокса (Ljung–Box), который проверяет значимость отклонения
r
τ
r
τ
от нуля. Основное правило, которое нужно здесь понять – если значение p-value критерия не превосходит
0.05
0.05 (или другого заранее фиксированного порога значимости), то автокорреляция с лагом
τ
τ значима. Это число вычисляется с помощью стандартных статистических пакетов (например, statsmodels в Питоне).
Рассмотрим временной ряд дорожно-транспортных происшествий за 14 лет с дискретностью 1 месяц, то есть с 12 измерениями в год. На графике мы видим явную сезонность. На нижнем графике изображена коррелограмма – график, визуализирующий автокорреляционную функцию. Точками на графике показаны значения автокорреляционной функции. Ее значение в нуле всегда равно 1, так как это автокорреляция ряда с собой же. Также мы видим, что значение
r
12
r
12
является локальным максимумом, что означает высокую положительную корреляцию значения ряда за текущий месяц с аналогичным значением год назад. Иными словами, ряд со сдвигом на год ведёт себя «похожим образом», и это подкрепляет наше наблюдение про наличие годичной сезонности. Наоборот, значение
r
6
r
6
минимально в своей окрестности, что означает высокую отрицательную корреляцию значения ряда со значением полгода назад. Закрашенная область визуализирует границу незначимой автокорреляции, то есть тех значений автокорреляции, для которых не выявлена статистически значимое отличие от 0 (иначе говоря, доверительный интервал пересекает 0). Так мы видим, что последняя значимая сезонная автокорреляция это – это
r
24
r
24
. Кроме нее также значима сезонная корреляция
r
12
r
12
и корреляция за половину сезона
r
6
r
6
. Из несезонных автокорреляций значимы оказались
. Отсюда можно сделать вывод, что для построения прогноза значения
y
t
y
t
имеет смысл рассматривать признаки
t−1
,y
t−2
,y
t−6
,y
t−12
,y
t−24
.
ex
ex
Рассмотрим временной ряд потребления электричества в Австралии с дискретностью 30 минут. По графику мы можем заметить две разных сезонности – суточную и недельную. Кроме того, при наличии большего количества данных мы смогли бы увидеть еще и годовую сезонность. На данном графике видно повышенное потребление электричества в январе-феврале, когда в Австралии жарко и работает много кондиционеров. По графику автокорреляций мы видим, что наибольшую корреляцию имеют соседние измерения, а также значения сутки назад, двое суток назад, и т.д. Наоборот, значения 12, 36, ... часов назад имеют отрицательную корреляцию.
ex
ex
Стационарные временные ряды
Временной ряд
y
t
y
t
называется стационарным
в узком смысле, если для любых
,...,t
n
,τ вектор
,...,y
t
n
+τ
) совпадает по распределению с
,...,y
t
n
), то есть при сдвиге всех моментов времени на одно и тоже число совместное распределение значений временного ряда в эти моменты времени не поменяется.
в широком смысле, если
<+∞ для любого
не зависит от
t
t, то есть в среднем значение временного ряда постоянно.
cov(y
t+τ
,y
s+τ
)=cov(y
t
,y
s
) для любых
t
,
s
,
τ
t,s,τ, то есть значение автокорреляции зависит только от длины отрезка времени между двумя значениями.
для гауссовских распределений, то есть для случая, когда все векторы вида
,...,y
t
n
) имеют нормальное распределение, определения эквивалентны. Это следует из того, что распределение гауссовского случайного вектора полностью определяется математическим ожиданием и ковариациями.
Пример. Рассмотрим временной ряд
y
t
=
ξ
1
cos
⁡
t
+
ξ
2
sin
cost+ξ
2
sint, где
и независимы и одинаково распределены, причем
P(ξ
1
=1)=P(ξ
1
=−1)=1/2.
Можем заметить, что
=0 и
cos
⁡
t
cos
sin
⁡
t
sin
cos
cov(y
t
,y
s
)=costcoss Dξ
1
+sintsins Dξ
2
=cos(t−s). Тем самым имеем стационарность в широком смысле.
Но при
t
=
0
t=0 получаем
∈{−1,1}, а при
t
=
π
/
4
t=π/4 получаем
π/4
∈{−
2
,0,
2
}.
Мы получили разные распределения, поэтому нет стационарности в узком смысле.
Некоторые примеры нестационарных временных рядов:
Случайное блуждание – пример:
t−1
+ε
t
, где
ε
t
ε
t
– белый шум, то есть независимые одинаково распределенные случайные величины. Математическое ожидание постоянно, но ряд не является стационарным, поскольку
D
y
t
Dy
t
бесконечно растет.
Временной ряд с трендом – пример:
=α+βt+ε
t
, где
ε
t
ε
t
– белый шум. Ряд не стационарен, так как
E
y
t
Ey
t
меняется с течением времени.
Временной ряд с сезонностью – пример:
y
t
=
sin
=sint+ε
t
, где
ε
t
ε
t
– белый шум. Не стационарен, так как
при
при
−1, при t=−π/2+2πk;
1, при t=t=π/2+2πk.
Стационарный ряд визуально не имеет предсказуемых закономерностей. Если посмотреть на график такого ряда издалека, то он будет горизонтален.
Ряд можно проверить строго на станционарность с помощью различных статистических критериев. Наиболее популярны следующие критерии:
критерий KPSS (Kwiatkowski–Phillips–Schmidt–Shin): если p-value
⩽
0.05
⩽0.05, то отвергаем стационарность;
критерий Дики-Фуллера: если p-value
⩽
0.05
⩽0.05, то отвергаем
НЕ
НЕстационарность.
Рассмотрим несколько примеров временных рядов:
ряды а, c, d, e, f, i не стационарны, поскольку они имеют тренд;
ряд b скорее всего стационарный, имеется выброс;
ряды d, g, h, i не стационарны, потому что имеют сезонность.
stationary
Когда вы определяете, чем вызвано изменение данных – трендом или шумом – стоит учитывать природу данных. Например, колебания значений ряда f теоретически можно было бы объяснить шумом в данных, но по временной оси мы видим, что данные представлены за 15 лет, соответственно, понимаем данные колебания как изменения тренда. Аналогично, для ряда d мы говорим о наличии меняющегося тренда помимо годовой сезонности.
Приведение к стационарным: стабилизация дисперсии
Зачем?
Данные методы рекомендуется использовать, если задача требует некоторой аналитики временного ряда. Если же требуется только построить точечный прогноз на будущее без построения предсказательных интервалов, то стабилизация дисперсии не является необходимой процедурой. Если же нас интересует предсказательный интервал, то многие методы лучше обрабатывают именно стационарные ряды, поэтому имеет смысл стабилизировать дисперсию.
Преобразования:
Класс преобразований Бокса-Кокса с параметром
lny
t
,
(y
t
λ
−1)/λ,
λ=0
λ

=0
.
Если есть предположения о зависимости
t, то можно рассмотреть ряд
После построения прогноза для преобразованного ряда нужно сделать обратное преобразование.
Приведение к стационарным: тренд и сезонность
Преобразования:
Дифференцирование ряда, то есть переход к ряду
,t∈{2,...,T}), где
t−1
. Данное преобразование используется для снятие тренда.
Сезонное дифференцирование ряда, то есть переход к ряду
,t∈{s+1,...,T}), где
t−s
,
s
s – длина сезона.
Преобразования можно применять несколько раз. Обычно сначала применяют сезонное дифференцирование.
Посмотрим на пример. В критерии KPSS для исходного ряда
0.01
pvalue<0.01, то есть ряд можно считать нестационарным. После логарифмирования ряда
0.01
pvalue<0.01, а после ещё и сезонного дифференцированная
0.1
pvalue>0.1, тем самым полученный ряд мы уже не можем отличить от стационарного.
ex
Модели вида экспоненциального сглаживания
Простое экспоненциальное сглаживание
Не редко временной ряд выглядит довольно шумным, что может достаточно плохо сказаться на работе других моделей и подходов к анализу этого временного ряда. В таком случае можно попытаться сгладить значения ряда. Далее мы рассмотрим несколько моделей сглаживания ряда, в том числе при наличии тренда и сезонности ряда. Помимо сглаживания истории ряда, с помощью данных методов можно также осуществлять простое прогнозирование ряда.
Пусть имеется временной ряд
y
t
y
t
. В результате экспоненциального сглаживания получается новый временной ряд
y
^
y
по правилу
t+1∣t
=αy
t
+(1−α)
y
t∣t−1
,
где
t+h∣t
– прогноз значения
y
t
+
h
y
t+h
в момент времени
t
t, а
α
α – параметр сглаживания.
Смысл преобразования следующий – сглаженное значение в момент времени
t
+
1
t+1 есть взвешенная комбинация предыдущего значения ряда
y
t
y
t
и предыдущего сглаженного значения ряда
t∣t−1
.
Свойства:
при
α
≈
1
α≈1 больший вес последнему значению ряда, поэтому получается слабое сглаживание
T+1∣T
≈y
T
;
при
α
≈
0
α≈0 больший вес отдается предыдущему сглаженному значению, и получается сильное сглаживание, что в пределе вырождается в среднее
T+1∣T
≈
y
;
Оптимальное значение
α
∗
α
∗
можно подобрать либо по графику, либо оптимизируя
min
⁡
α
.
t=t
(α)−y
t
)
2
→
α
min
.
Существуют следующие эмпирические правила:
если
0.3
)
α
∗
∈(0,0.3) то ряд стационарен, можно применять экспоненциальное сглаживание без риска большой потери информации;
если
α
∗
∈
(
0.3
,
1
)
α
∗
∈(0.3,1) то ряд нестационарен, применение экспоненциального сглаживания может привести к потере информации или смещению.
Примеры: на каждом из графиков изображен исходный ряд (синий) и сглаженный ряд (оранжевый) для разных значений параметра сглаживания. Если имеется тренд или сезонность, то при большом сглаживании полученный ряд начинает «запаздывать» за исходным рядом.
es001
es01
Откуда взялась эта формула экспоненциального сглаживания?
Покажем, что сглаженное значение соответствует прогнозу величины
x
x в момент времени
T
+
1
T+1, подбираемому по правилу
min
⁡
x
.
t=0
∑
T
β
T−t
(y
t
−x)
2
→
x
min
.
Иначе говоря, для прогнозирования мы берем взвешенный MSE с экспоненциально убывающими по времени весами.
Приравняем производную к нулю:
t=0
∑
T
β
T−t
(y
t
−x)=0
Отсюда выразим
x
x и воспользуемся разложением функции
1
1
−
x
1−x
1
в ряд Тейлора
t=0
∑
T
β
t
t=0
∑
T
β
T−t
y
t
≈
1/(1−β)
t=0
∑
T
β
T−t
y
t
=(1−β)
t=0
∑
T
β
T−t
=(1−β)y
T
+(1−β)β
t=0
∑
T−1
β
T−1−t
y
t
=(1−β)y
T
+β
y
T∣T−1
Тем самым мы получили модель экспоненциального сглаживания для
β
=
1
−
α
β=1−α.
Модель Хольта
Аддитивный линейный тренд:
Прогноз на
d
d шагов вперед выражается с помощью линейной функции от числа шагов, где коэффициенты меняются по формулам, аналогичным экспоненциальному сглаживанию
t+d∣t
=a
t
+b
t
⋅d,
=αy
t
+(1−α)(a
t−1
+b
t−1
=β(a
t
−a
t−1
)+(1−β)b
t−1
Модель для мультипликативного линейного тренда выглядит аналогично
t+d∣t
=αy
t
+(1−α)(a
t−1
b
t−1
t−1
a
t
+(1−β)b
t−1
Модель Хольта: пояснение формул
Поясним на примере аддитивного тренда, почему формулы для
получаются именно такими.
Заметим, что для
d
=
0
d=0 и
d
=
1
d=1 и момента времени
t
+
1
t+1 получаем
t+1∣t+1
=a
t+1
t+1∣t
=a
t
+b
t
. Хотелось бы, чтобы эти прогнозы примерно совпадали, то есть чтобы имело место
t+1
−a
t
≈b
t
.
Рассмотрим ряд разностей
t+1
−a
t
и задачу константного прогноза для него (то есть
t∣t−1
=b) методом простого экспоненциального сглаживания
min
⁡
b
.
i=0
∑
t
(1−β)
t−i
(Δy
i
−b)
2
→
b
min
.
Ее решение мы уже получили ранее:
=βΔy
t−1
+(1−β)b
t−1
=β(a
t
−a
t−1
)+(1−β)b
t−1
.
Получилась формулу для
b
t
b
t
в модели аддитивного тренда.
Далее, мы хотим, чтобы имело место
t+1
≈b
t
+a
t
. Рассматривая для
y
t
y
t
экспоненциальное сглаживание, в котором в качестве предыдущего значения сглаженного ряда берется
, а в качестве нового –
a
t
+
1
a
t+1
, получаем
=αy
t
+(1−α)(a
t−1
+b
t−1
).
Модель Хольта-Уинтерса
Аддитивная сезонность с трендом:
mod
m
)
,
y
t+d∣t
=a
t
+db
t
+s
t−m+(d mod m)
=α(y
t
−s
t−m
)+(1−α)(a
t−1
+b
t−1
=β(a
t
−a
t−1
)+(1−β)b
t−1
=γ(y
t
−a
t
)+(1−γ)s
t−m
где
m
m – длина сезона
Мультипликативная сезонность
Без тренда
mod
m
)
,
y
t+d∣t
=a
t
⋅s
t−m+(d mod m)
=α(y
t
/s
t−m
)+(1−α)a
t−1
=γ(y
t
/a
t
)+(1−γ)s
t−m
С линейным трендом
mod
m
)
,
y
t+d∣t
=(a
t
+db
t
)s
t−m+(d mod m)
t−m
y
t
+(1−α)(a
t−1
+b
t−1
=β(a
t
−a
t−1
)+(1−β)b
t−1
+(1−γ)s
t−m
Разные модели с трендом и сезонностью
trends
Адаптивное сглаживание
В примерах выше мы видели, что при изменении локального тренда ряда экспоненциальное сглаживание запаздывает за значениями ряда при использовании сильного сглаживания. Если же использовать слабое сглаживание, то существенного запаздывания не происходит, но ряд остается шумным. Если для ряда предполагаются значительные структурные изменения, можно использовать модель адаптивного экспоненциального сглаживания, в которой параметр сглаживания может меняться для разных отрезков временного ряда.
Пусть
y
^
t
y
t
– прогноз значения
y
t
y
t
в момент времени
t
−
1
t−1 обычным экспоненциальным сглаживанием, а
– ошибка прогноза, сделанного на шаге
t
−
1
t−1.
Определим следующие значения
Среднее значение ошибки:
+(1−γ)E
t−1
.
Средний разброс ошибки:
=γ∣
ε
t
∣+(1−γ)A
t−1
– статистика, которая сигнализирует, насколько адекватно модель работает в момент времени
≈±1 – модель систематически ошибается в одну сторону.
≈0 – модель работает адекватно.
Обычно берут значения
γ
∈
(
0.05
,
0.1
)
γ∈(0.05,0.1).
Чтобы экспоненциальное сглаживание быстро приспосабливалось к резким структурным изменениям берут
α
t
=
min
=min(∣K
t
∣,1).
Однако, у данного подхода есть и недостатки, например,
плохо реагирует на одиночные выбросы;
требует подбора
γ
γ.
adaptive
Знак вопроса
Пройдите квиз по параграфу
Чтобы закрепить пройденный материал
Сообщить об ошибке
Предыдущий параграф
10.2. Временные ряды
Следующий параграф
10.4. Модели вида ARIMA
